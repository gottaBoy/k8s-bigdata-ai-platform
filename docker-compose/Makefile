# Docker Composeæœ¬åœ°æµ‹è¯•ç¯å¢ƒ - Makefile
# ä½œè€…: äº‘åŸç”Ÿä¸“å®¶
# ç‰ˆæœ¬: 1.0.0

.PHONY: help start stop restart status logs clean init-data

# é»˜è®¤ç›®æ ‡
help:
	@echo "Docker Composeæœ¬åœ°æµ‹è¯•ç¯å¢ƒ - å¯ç”¨å‘½ä»¤"
	@echo ""
	@echo "åŸºç¡€æ“ä½œ:"
	@echo "  make start       - å¯åŠ¨æ‰€æœ‰æœåŠ¡"
	@echo "  make stop        - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "  make restart     - é‡å¯æ‰€æœ‰æœåŠ¡"
	@echo "  make status      - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "  make logs        - æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
	@echo "  make clean       - æ¸…ç†ç¯å¢ƒ"
	@echo ""
	@echo "æ•°æ®æ“ä½œ:"
	@echo "  make init-data   - åˆå§‹åŒ–æ•°æ®"
	@echo "  make backup      - å¤‡ä»½æ•°æ®"
	@echo "  make restore     - æ¢å¤æ•°æ®"
	@echo ""
	@echo "æœåŠ¡ç®¡ç†:"
	@echo "  make start-storage     - å¯åŠ¨å­˜å‚¨æœåŠ¡"
	@echo "  make start-messaging   - å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—"
	@echo "  make start-database    - å¯åŠ¨æ•°æ®ä»“åº“"
	@echo "  make start-streaming   - å¯åŠ¨æµå¤„ç†"
	@echo "  make start-monitoring  - å¯åŠ¨ç›‘æ§"
	@echo "  make start-apps        - å¯åŠ¨åº”ç”¨æœåŠ¡"
	@echo ""

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
start:
	@echo "å¯åŠ¨å¤§æ•°æ®AIå¹³å°æœ¬åœ°æµ‹è¯•ç¯å¢ƒ..."
	@./start.sh

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop:
	@echo "åœæ­¢æ‰€æœ‰æœåŠ¡..."
	@docker-compose stop

# é‡å¯æ‰€æœ‰æœåŠ¡
restart:
	@echo "é‡å¯æ‰€æœ‰æœåŠ¡..."
	@docker-compose restart

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status:
	@echo "=== æœåŠ¡çŠ¶æ€ ==="
	@docker-compose ps
	@echo ""
	@echo "=== èµ„æºä½¿ç”¨ ==="
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
logs:
	@echo "æŸ¥çœ‹æœåŠ¡æ—¥å¿—..."
	@docker-compose logs -f

# æ¸…ç†ç¯å¢ƒ
clean:
	@echo "æ¸…ç†Docker Composeç¯å¢ƒ..."
	@echo "è­¦å‘Š: è¿™å°†åˆ é™¤æ‰€æœ‰å®¹å™¨ã€ç½‘ç»œå’Œæ•°æ®å·ï¼"
	@read -p "ç¡®è®¤åˆ é™¤? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@docker-compose down -v --rmi all
	@docker system prune -f
	@echo "ç¯å¢ƒæ¸…ç†å®Œæˆ"

# åˆå§‹åŒ–æ•°æ®
init-data:
	@echo "åˆå§‹åŒ–å¹³å°æ•°æ®..."
	@chmod +x scripts/init-data.sh
	@./scripts/init-data.sh

# å¤‡ä»½æ•°æ®
backup:
	@echo "å¤‡ä»½å¹³å°æ•°æ®..."
	@mkdir -p backups/$(shell date +%Y%m%d-%H%M%S)
	@docker-compose exec minio mc mirror myminio/bigdata-lake backups/$(shell date +%Y%m%d-%H%M%S)/minio/ || true
	@docker-compose exec doris-fe mysqldump -h localhost -P 9030 -u root -p bigdata_platform > backups/$(shell date +%Y%m%d-%H%M%S)/doris_backup.sql || true
	@echo "å¤‡ä»½å®Œæˆ: backups/$(shell date +%Y%m%d-%H%M%S)/"

# æ¢å¤æ•°æ®
restore:
	@echo "æ¢å¤å¹³å°æ•°æ®..."
	@read -p "è¾“å…¥å¤‡ä»½ç›®å½•: " backup_dir && \
	if [ -d "$$backup_dir" ]; then \
		if [ -d "$$backup_dir/minio" ]; then \
			docker-compose exec minio mc mirror backups/$$backup_dir/minio/ myminio/bigdata-lake/ || true; \
		fi; \
		if [ -f "$$backup_dir/doris_backup.sql" ]; then \
			docker-compose exec doris-fe mysql -h localhost -P 9030 -u root -p < $$backup_dir/doris_backup.sql || true; \
		fi; \
		echo "æ•°æ®æ¢å¤å®Œæˆ"; \
	else \
		echo "å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $$backup_dir"; \
	fi

# å¯åŠ¨å­˜å‚¨æœåŠ¡
start-storage:
	@echo "å¯åŠ¨å­˜å‚¨æœåŠ¡..."
	@docker-compose up -d minio redis

# å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—
start-messaging:
	@echo "å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—..."
	@docker-compose up -d zookeeper kafka kafka-ui

# å¯åŠ¨æ•°æ®ä»“åº“
start-database:
	@echo "å¯åŠ¨æ•°æ®ä»“åº“..."
	@docker-compose up -d doris-fe doris-be

# å¯åŠ¨æµå¤„ç†
start-streaming:
	@echo "å¯åŠ¨æµå¤„ç†..."
	@docker-compose up -d flink-jobmanager flink-taskmanager

# å¯åŠ¨ç›‘æ§
start-monitoring:
	@echo "å¯åŠ¨ç›‘æ§..."
	@docker-compose up -d prometheus grafana

# å¯åŠ¨åº”ç”¨æœåŠ¡
start-apps:
	@echo "å¯åŠ¨åº”ç”¨æœåŠ¡..."
	@docker-compose up -d airflow-postgres airflow-redis airflow-webserver airflow-scheduler superset-postgres superset jupyterhub

# æŸ¥çœ‹è®¿é—®ä¿¡æ¯
access-info:
	@echo "=== å¹³å°è®¿é—®ä¿¡æ¯ ==="
	@echo ""
	@echo "ğŸŒ æœåŠ¡è®¿é—®åœ°å€:"
	@echo "  MinIO Console:     http://localhost:9001 (admin/minio123)"
	@echo "  Kafka UI:          http://localhost:8082"
	@echo "  Doris FE:          http://localhost:8030"
	@echo "  Doris BE:          http://localhost:8040"
	@echo "  Flink JobManager:  http://localhost:8081"
	@echo "  Prometheus:        http://localhost:9090"
	@echo "  Grafana:           http://localhost:3000 (admin/admin123)"
	@echo "  Airflow:           http://localhost:8080 (admin/admin123)"
	@echo "  Superset:          http://localhost:8088 (admin/admin123)"
	@echo "  JupyterHub:        http://localhost:8000 (admin/jupyter123)"
	@echo ""
	@echo "ğŸ”§ è¿æ¥ä¿¡æ¯:"
	@echo "  MinIO:             localhost:9000 (admin/minio123)"
	@echo "  Kafka:             localhost:9092"
	@echo "  Doris:             localhost:9030 (root/root)"
	@echo "  Redis:             localhost:6379 (redis123)"
	@echo "  PostgreSQL:        localhost:5432 (airflow/airflow123)"

# å¥åº·æ£€æŸ¥
health-check:
	@echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
	@echo "=== æœåŠ¡å¥åº·çŠ¶æ€ ==="
	@docker-compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
	@echo ""
	@echo "=== ç«¯å£æ£€æŸ¥ ==="
	@for port in 9000 9001 8082 8030 8040 8081 9090 3000 8080 8088 8000; do \
		if curl -s http://localhost:$$port > /dev/null 2>&1; then \
			echo "âœ“ localhost:$$port - æ­£å¸¸"; \
		else \
			echo "âœ— localhost:$$port - å¼‚å¸¸"; \
		fi; \
	done

# æ€§èƒ½ç›‘æ§
monitor:
	@echo "æ€§èƒ½ç›‘æ§..."
	@echo "=== å®¹å™¨èµ„æºä½¿ç”¨ ==="
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}"
	@echo ""
	@echo "=== ç£ç›˜ä½¿ç”¨ ==="
	@docker system df

# å¿«é€Ÿæµ‹è¯•
test:
	@echo "æ‰§è¡Œå¿«é€Ÿæµ‹è¯•..."
	@echo "1. æµ‹è¯•MinIOè¿æ¥..."
	@docker exec minio-client mc ls myminio/ 2>/dev/null || echo "MinIOè¿æ¥å¤±è´¥"
	@echo "2. æµ‹è¯•Kafkaè¿æ¥..."
	@docker exec kafka kafka-topics --list --bootstrap-server localhost:9092 2>/dev/null || echo "Kafkaè¿æ¥å¤±è´¥"
	@echo "3. æµ‹è¯•Dorisè¿æ¥..."
	@docker exec doris-fe mysql -h localhost -P 9030 -u root -e "SHOW DATABASES;" 2>/dev/null || echo "Dorisè¿æ¥å¤±è´¥"
	@echo "4. æµ‹è¯•Redisè¿æ¥..."
	@docker exec redis redis-cli -a redis123 ping 2>/dev/null || echo "Redisè¿æ¥å¤±è´¥"
	@echo "æµ‹è¯•å®Œæˆ"

# ä¸€é”®éƒ¨ç½²
deploy:
	@echo "ä¸€é”®éƒ¨ç½²å¤§æ•°æ®AIå¹³å°..."
	@make start
	@echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
	@sleep 60
	@make init-data
	@make access-info
	@echo "éƒ¨ç½²å®Œæˆï¼"

# å¼€å‘æ¨¡å¼
dev:
	@echo "å¯åŠ¨å¼€å‘æ¨¡å¼..."
	@docker-compose up -d minio redis kafka doris-fe doris-be flink-jobmanager flink-taskmanager
	@echo "å¼€å‘ç¯å¢ƒå·²å¯åŠ¨ï¼ŒåŒ…å«: MinIO, Redis, Kafka, Doris, Flink"
	@echo "è®¿é—®åœ°å€:"
	@echo "  MinIO: http://localhost:9001"
	@echo "  Kafka UI: http://localhost:8082"
	@echo "  Doris: http://localhost:8030"
	@echo "  Flink: http://localhost:8081"

# ç”Ÿäº§æ¨¡å¼
prod:
	@echo "å¯åŠ¨ç”Ÿäº§æ¨¡å¼..."
	@docker-compose up -d
	@echo "ç”Ÿäº§ç¯å¢ƒå·²å¯åŠ¨ï¼ŒåŒ…å«æ‰€æœ‰æœåŠ¡"
	@make access-info 