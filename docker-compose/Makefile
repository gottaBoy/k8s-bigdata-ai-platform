# Docker Composeæœ¬åœ°æµ‹è¯•ç¯å¢ƒ - Makefile
# ä½œè€…: äº‘åŸç”Ÿä¸“å®¶
# ç‰ˆæœ¬: 1.0.0

.PHONY: help start stop restart status logs clean init-data health-check optimize

# é»˜è®¤ç›®æ ‡
help:
	@echo "Docker Composeæœ¬åœ°æµ‹è¯•ç¯å¢ƒ - å¯ç”¨å‘½ä»¤"
	@echo ""
	@echo "åŸºç¡€æ“ä½œ:"
	@echo "  make start       - å¯åŠ¨æ‰€æœ‰æœåŠ¡"
	@echo "  make stop        - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "  make restart     - é‡å¯æ‰€æœ‰æœåŠ¡"
	@echo "  make status      - æŸ¥çœ‹æœåŠ¡çŠ¶æ€"
	@echo "  make logs        - æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
	@echo "  make clean       - æ¸…ç†ç¯å¢ƒ"
	@echo ""
	@echo "æ•°æ®æ“ä½œ:"
	@echo "  make init-data   - åˆå§‹åŒ–æ•°æ®"
	@echo "  make backup      - å¤‡ä»½æ•°æ®"
	@echo "  make restore     - æ¢å¤æ•°æ®"
	@echo ""
	@echo "ç›‘æ§å’Œå¥åº·æ£€æŸ¥:"
	@echo "  make health-check - æ‰§è¡Œå¥åº·æ£€æŸ¥"
	@echo "  make monitor     - æ€§èƒ½ç›‘æ§"
	@echo "  make test        - å¿«é€Ÿæµ‹è¯•"
	@echo ""
	@echo "æœåŠ¡ç®¡ç†:"
	@echo "  make start-storage     - å¯åŠ¨å­˜å‚¨æœåŠ¡"
	@echo "  make start-messaging   - å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—"
	@echo "  make start-database    - å¯åŠ¨æ•°æ®ä»“åº“"
	@echo "  make start-streaming   - å¯åŠ¨æµå¤„ç†"
	@echo "  make start-monitoring  - å¯åŠ¨ç›‘æ§"
	@echo "  make start-apps        - å¯åŠ¨åº”ç”¨æœåŠ¡"
	@echo ""
	@echo "ä¼˜åŒ–å’Œç»´æŠ¤:"
	@echo "  make optimize    - æ€§èƒ½ä¼˜åŒ–"
	@echo "  make compact     - æ•°æ®å‹ç¼©"
	@echo "  make cleanup     - æ•°æ®æ¸…ç†"
	@echo "  make upgrade     - å‡çº§æœåŠ¡"
	@echo ""

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
start:
	@echo "å¯åŠ¨å¤§æ•°æ®AIå¹³å°æœ¬åœ°æµ‹è¯•ç¯å¢ƒ..."
	@./start.sh

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop:
	@echo "åœæ­¢æ‰€æœ‰æœåŠ¡..."
	@docker-compose stop

# é‡å¯æ‰€æœ‰æœåŠ¡
restart:
	@echo "é‡å¯æ‰€æœ‰æœåŠ¡..."
	@docker-compose restart

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
status:
	@echo "=== æœåŠ¡çŠ¶æ€ ==="
	@docker-compose ps
	@echo ""
	@echo "=== èµ„æºä½¿ç”¨ ==="
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
logs:
	@echo "æŸ¥çœ‹æœåŠ¡æ—¥å¿—..."
	@docker-compose logs -f

# æ¸…ç†ç¯å¢ƒ
clean:
	@echo "æ¸…ç†Docker Composeç¯å¢ƒ..."
	@echo "è­¦å‘Š: è¿™å°†åˆ é™¤æ‰€æœ‰å®¹å™¨ã€ç½‘ç»œå’Œæ•°æ®å·ï¼"
	@read -p "ç¡®è®¤åˆ é™¤? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@docker-compose down -v --rmi all
	@docker system prune -f
	@echo "ç¯å¢ƒæ¸…ç†å®Œæˆ"

# åˆå§‹åŒ–æ•°æ®
init-data:
	@echo "åˆå§‹åŒ–å¹³å°æ•°æ®..."
	@chmod +x scripts/init-data.sh
	@./scripts/init-data.sh

# å¥åº·æ£€æŸ¥
health-check:
	@echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
	@chmod +x scripts/health-check.sh
	@./scripts/health-check.sh

# æ€§èƒ½ç›‘æ§
monitor:
	@echo "æ€§èƒ½ç›‘æ§..."
	@echo "=== å®¹å™¨èµ„æºä½¿ç”¨ ==="
	@docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}"
	@echo ""
	@echo "=== ç£ç›˜ä½¿ç”¨ ==="
	@docker system df

# å¿«é€Ÿæµ‹è¯•
test:
	@echo "æ‰§è¡Œå¿«é€Ÿæµ‹è¯•..."
	@echo "1. æµ‹è¯•MinIOè¿æ¥..."
	@docker exec minio-client mc ls myminio/ 2>/dev/null || echo "MinIOè¿æ¥å¤±è´¥"
	@echo "2. æµ‹è¯•Kafkaè¿æ¥..."
	@docker exec kafka kafka-topics --list --bootstrap-server localhost:9092 2>/dev/null || echo "Kafkaè¿æ¥å¤±è´¥"
	@echo "3. æµ‹è¯•Dorisè¿æ¥..."
	@docker exec doris-fe mysql -h localhost -P 9030 -u root -e "SHOW DATABASES;" 2>/dev/null || echo "Dorisè¿æ¥å¤±è´¥"
	@echo "4. æµ‹è¯•Redisè¿æ¥..."
	@docker exec redis redis-cli -a redis123 ping 2>/dev/null || echo "Redisè¿æ¥å¤±è´¥"
	@echo "5. æµ‹è¯•Flinkè¿æ¥..."
	@curl -s http://localhost:8081 > /dev/null 2>&1 && echo "Flinkè¿æ¥æˆåŠŸ" || echo "Flinkè¿æ¥å¤±è´¥"
	@echo "6. æµ‹è¯•PaimonçŠ¶æ€..."
	@docker ps | grep -q "paimon-catalog" && echo "PaimonæœåŠ¡è¿è¡Œä¸­" || echo "PaimonæœåŠ¡æœªè¿è¡Œ"
	@echo "æµ‹è¯•å®Œæˆ"

# å¤‡ä»½æ•°æ®
backup:
	@echo "å¤‡ä»½å¹³å°æ•°æ®..."
	@mkdir -p backups/$(shell date +%Y%m%d-%H%M%S)
	@docker-compose exec minio mc mirror myminio/bigdata-lake backups/$(shell date +%Y%m%d-%H%M%S)/minio/ || true
	@docker-compose exec doris-fe mysqldump -h localhost -P 9030 -u root -p bigdata_platform > backups/$(shell date +%Y%m%d-%H%M%S)/doris_backup.sql || true
	@echo "å¤‡ä»½å®Œæˆ: backups/$(shell date +%Y%m%d-%H%M%S)/"

# æ¢å¤æ•°æ®
restore:
	@echo "æ¢å¤å¹³å°æ•°æ®..."
	@read -p "è¾“å…¥å¤‡ä»½ç›®å½•: " backup_dir && \
	if [ -d "$$backup_dir" ]; then \
		if [ -d "$$backup_dir/minio" ]; then \
			docker-compose exec minio mc mirror backups/$$backup_dir/minio/ myminio/bigdata-lake/ || true; \
		fi; \
		if [ -f "$$backup_dir/doris_backup.sql" ]; then \
			docker-compose exec doris-fe mysql -h localhost -P 9030 -u root -p < $$backup_dir/doris_backup.sql || true; \
		fi; \
		echo "æ•°æ®æ¢å¤å®Œæˆ"; \
	else \
		echo "å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $$backup_dir"; \
	fi

# å¯åŠ¨å­˜å‚¨æœåŠ¡
start-storage:
	@echo "å¯åŠ¨å­˜å‚¨æœåŠ¡..."
	@docker-compose up -d minio redis

# å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—
start-messaging:
	@echo "å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—..."
	@docker-compose up -d zookeeper kafka kafka-ui

# å¯åŠ¨æ•°æ®ä»“åº“
start-database:
	@echo "å¯åŠ¨æ•°æ®ä»“åº“..."
	@docker-compose up -d doris-fe doris-be

# å¯åŠ¨æµå¤„ç†
start-streaming:
	@echo "å¯åŠ¨æµå¤„ç†..."
	@docker-compose up -d flink-jobmanager flink-taskmanager paimon-catalog

# å¯åŠ¨ç›‘æ§
start-monitoring:
	@echo "å¯åŠ¨ç›‘æ§..."
	@docker-compose up -d prometheus grafana

# å¯åŠ¨åº”ç”¨æœåŠ¡
start-apps:
	@echo "å¯åŠ¨åº”ç”¨æœåŠ¡..."
	@docker-compose up -d airflow-postgres airflow-redis airflow-webserver airflow-scheduler superset-postgres superset jupyterhub

# æ€§èƒ½ä¼˜åŒ–
optimize:
	@echo "æ‰§è¡Œæ€§èƒ½ä¼˜åŒ–..."
	@echo "1. ä¼˜åŒ–Flinké…ç½®..."
	@docker exec flink-jobmanager /opt/flink/bin/flink run -d /opt/flink/examples/streaming/WordCount.jar || true
	@echo "2. ä¼˜åŒ–Paimonè¡¨..."
	@docker exec paimon-catalog /opt/flink/bin/sql-client.sh -e "OPTIMIZE TABLE user_events;" || true
	@echo "3. æ¸…ç†è¿‡æœŸæ•°æ®..."
	@docker exec doris-fe mysql -h localhost -P 9030 -u root -e "DELETE FROM user_events WHERE event_date < DATE_SUB(CURDATE(), INTERVAL 7 DAY);" || true
	@echo "4. å‹ç¼©æ•°æ®æ–‡ä»¶..."
	@docker exec minio-client mc admin bucket-encrypt myminio/bigdata-lake || true
	@echo "æ€§èƒ½ä¼˜åŒ–å®Œæˆ"

# æ•°æ®å‹ç¼©
compact:
	@echo "æ‰§è¡Œæ•°æ®å‹ç¼©..."
	@echo "1. å‹ç¼©Paimonè¡¨..."
	@docker exec paimon-catalog /opt/flink/bin/sql-client.sh -e "CALL paimon.system.compact('user_events');" || true
	@docker exec paimon-catalog /opt/flink/bin/sql-client.sh -e "CALL paimon.system.compact('sales_data');" || true
	@echo "2. å‹ç¼©Dorisè¡¨..."
	@docker exec doris-fe mysql -h localhost -P 9030 -u root -e "ALTER TABLE user_events COMPACT;" || true
	@echo "3. æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
	@docker system prune -f
	@echo "æ•°æ®å‹ç¼©å®Œæˆ"

# æ•°æ®æ¸…ç†
cleanup:
	@echo "æ‰§è¡Œæ•°æ®æ¸…ç†..."
	@echo "1. æ¸…ç†è¿‡æœŸå¿«ç…§..."
	@docker exec paimon-catalog /opt/flink/bin/sql-client.sh -e "CALL paimon.system.expire_snapshots('user_events', '7d');" || true
	@echo "2. æ¸…ç†è¿‡æœŸæ–‡ä»¶..."
	@docker exec paimon-catalog /opt/flink/bin/sql-client.sh -e "CALL paimon.system.expire_files('user_events', '7d');" || true
	@echo "3. æ¸…ç†Dockeré•œåƒ..."
	@docker image prune -f
	@echo "4. æ¸…ç†Dockerå·..."
	@docker volume prune -f
	@echo "æ•°æ®æ¸…ç†å®Œæˆ"

# å‡çº§æœåŠ¡
upgrade:
	@echo "å‡çº§æœåŠ¡..."
	@echo "1. æ‹‰å–æœ€æ–°é•œåƒ..."
	@docker-compose pull
	@echo "2. å¤‡ä»½å½“å‰æ•°æ®..."
	@make backup
	@echo "3. é‡å¯æœåŠ¡..."
	@docker-compose up -d
	@echo "4. éªŒè¯æœåŠ¡çŠ¶æ€..."
	@make health-check
	@echo "æœåŠ¡å‡çº§å®Œæˆ"

# æŸ¥çœ‹è®¿é—®ä¿¡æ¯
access-info:
	@echo "=== å¹³å°è®¿é—®ä¿¡æ¯ ==="
	@echo ""
	@echo "ğŸŒ æœåŠ¡è®¿é—®åœ°å€:"
	@echo "  MinIO Console:     http://localhost:9001 (admin/minio123)"
	@echo "  Kafka UI:          http://localhost:8082"
	@echo "  Doris FE:          http://localhost:8030"
	@echo "  Doris BE:          http://localhost:8040"
	@echo "  Flink JobManager:  http://localhost:8081"
	@echo "  Paimon Data Lake:  s3://bigdata-lake/paimon"
	@echo "  Prometheus:        http://localhost:9090"
	@echo "  Grafana:           http://localhost:3000 (admin/admin123)"
	@echo "  Airflow:           http://localhost:8080 (admin/admin123)"
	@echo "  Superset:          http://localhost:8088 (admin/admin123)"
	@echo "  JupyterHub:        http://localhost:8000 (admin/jupyter123)"
	@echo ""
	@echo "ğŸ”§ è¿æ¥ä¿¡æ¯:"
	@echo "  MinIO:             localhost:9000 (admin/minio123)"
	@echo "  Kafka:             localhost:9092"
	@echo "  Doris:             localhost:9030 (root/root)"
	@echo "  Redis:             localhost:6379 (redis123)"
	@echo "  PostgreSQL:        localhost:5432 (airflow/airflow123)"
	@echo ""
	@echo "ğŸ“Š ç›‘æ§é¢æ¿:"
	@echo "  Grafana:           http://localhost:3000"
	@echo "  Prometheus:        http://localhost:9090"
	@echo "  Kafka UI:          http://localhost:8082"

# ä¸€é”®éƒ¨ç½²
deploy:
	@echo "ä¸€é”®éƒ¨ç½²å¤§æ•°æ®AIå¹³å°..."
	@make start
	@echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
	@sleep 60
	@make init-data
	@make health-check
	@make access-info
	@echo "éƒ¨ç½²å®Œæˆï¼"

# å¼€å‘æ¨¡å¼
dev:
	@echo "å¯åŠ¨å¼€å‘æ¨¡å¼..."
	@docker-compose up -d minio redis kafka doris-fe doris-be flink-jobmanager flink-taskmanager paimon-catalog
	@echo "å¼€å‘ç¯å¢ƒå·²å¯åŠ¨ï¼ŒåŒ…å«: MinIO, Redis, Kafka, Doris, Flink, Paimon"
	@echo "è®¿é—®åœ°å€:"
	@echo "  MinIO: http://localhost:9001"
	@echo "  Kafka UI: http://localhost:8082"
	@echo "  Doris: http://localhost:8030"
	@echo "  Flink: http://localhost:8081"
	@echo "  Paimon: s3://bigdata-lake/paimon"

# ç”Ÿäº§æ¨¡å¼
prod:
	@echo "å¯åŠ¨ç”Ÿäº§æ¨¡å¼..."
	@docker-compose up -d
	@echo "ç”Ÿäº§ç¯å¢ƒå·²å¯åŠ¨ï¼ŒåŒ…å«æ‰€æœ‰æœåŠ¡"
	@make access-info

# æ•…éšœæ’æŸ¥
troubleshoot:
	@echo "æ•…éšœæ’æŸ¥..."
	@echo "1. æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
	@docker-compose ps
	@echo ""
	@echo "2. æ£€æŸ¥æœåŠ¡æ—¥å¿—..."
	@docker-compose logs --tail=50
	@echo ""
	@echo "3. æ£€æŸ¥ç½‘ç»œè¿æ¥..."
	@docker network ls
	@echo ""
	@echo "4. æ£€æŸ¥èµ„æºä½¿ç”¨..."
	@docker stats --no-stream
	@echo ""
	@echo "5. ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š..."
	@make health-check

# æ€§èƒ½åŸºå‡†æµ‹è¯•
benchmark:
	@echo "æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
	@echo "1. æµ‹è¯•æ•°æ®å†™å…¥æ€§èƒ½..."
	@docker exec kafka kafka-producer-perf-test --topic test-topic --num-records 10000 --record-size 1000 --throughput 1000 --producer-props bootstrap.servers=localhost:9092 || true
	@echo "2. æµ‹è¯•æ•°æ®è¯»å–æ€§èƒ½..."
	@docker exec kafka kafka-consumer-perf-test --topic test-topic --bootstrap-server localhost:9092 --messages 10000 || true
	@echo "3. æµ‹è¯•Flinkä½œä¸šæ€§èƒ½..."
	@docker exec flink-jobmanager /opt/flink/bin/flink run -d /opt/flink/examples/streaming/WordCount.jar || true
	@echo "4. æµ‹è¯•PaimonæŸ¥è¯¢æ€§èƒ½..."
	@docker exec paimon-catalog /opt/flink/bin/sql-client.sh -e "SELECT COUNT(*) FROM user_events;" || true
	@echo "æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ"

# å®‰å…¨æ‰«æ
security-scan:
	@echo "æ‰§è¡Œå®‰å…¨æ‰«æ..."
	@echo "1. æ‰«æDockeré•œåƒæ¼æ´..."
	@docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image minio/minio:RELEASE.2023-11-15T20-43-25Z || true
	@echo "2. æ£€æŸ¥å®¹å™¨æƒé™..."
	@docker ps --format "table {{.Names}}\t{{.Status}}" | grep -v "Up" || echo "æ‰€æœ‰å®¹å™¨è¿è¡Œæ­£å¸¸"
	@echo "3. æ£€æŸ¥ç½‘ç»œéš”ç¦»..."
	@docker network inspect bigdata-network --format='{{range .Containers}}{{.Name}} {{end}}' || true
	@echo "å®‰å…¨æ‰«æå®Œæˆ"

# å¤‡ä»½å’Œæ¢å¤
backup-restore:
	@echo "å¤‡ä»½å’Œæ¢å¤ç®¡ç†..."
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make backup    - å¤‡ä»½æ•°æ®"
	@echo "  make restore   - æ¢å¤æ•°æ®"
	@echo "  make compact   - å‹ç¼©æ•°æ®"
	@echo "  make cleanup   - æ¸…ç†æ•°æ®"

# ç›‘æ§å’Œå‘Šè­¦
monitoring:
	@echo "ç›‘æ§å’Œå‘Šè­¦ç®¡ç†..."
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make health-check - å¥åº·æ£€æŸ¥"
	@echo "  make monitor     - æ€§èƒ½ç›‘æ§"
	@echo "  make test        - å¿«é€Ÿæµ‹è¯•"
	@echo "  make benchmark   - æ€§èƒ½åŸºå‡†æµ‹è¯•"

# ç»´æŠ¤å’Œä¼˜åŒ–
maintenance:
	@echo "ç»´æŠ¤å’Œä¼˜åŒ–ç®¡ç†..."
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make optimize    - æ€§èƒ½ä¼˜åŒ–"
	@echo "  make compact     - æ•°æ®å‹ç¼©"
	@echo "  make cleanup     - æ•°æ®æ¸…ç†"
	@echo "  make upgrade     - å‡çº§æœåŠ¡"
	@echo "  make security-scan - å®‰å…¨æ‰«æ" 